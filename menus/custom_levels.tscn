[gd_scene load_steps=9 format=3 uid="uid://c3746gmhgb8n"]

[ext_resource type="Script" path="res://scripts/Menu.gd" id="1_qmt1b"]

[sub_resource type="GDScript" id="GDScript_dnww3"]
script/source = "extends Button

@export var file_dialog : FileDialog


func _on_button_up():
	file_dialog.popup_centered(Vector2i(1000, 1000))
	
"

[sub_resource type="GDScript" id="GDScript_yf5o0"]
script/source = "extends Button

@export var window : Window

# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	pass


func _on_button_up():
	window.popup_centered()
"

[sub_resource type="GDScript" id="GDScript_c727j"]
script/source = "extends Button

@export var line_edit : LineEdit
@export var level_starter : Node

func _on_button_up():
	level_starter.start_level_from_url(line_edit.text)
"

[sub_resource type="GDScript" id="GDScript_t044l"]
script/source = "extends Label

var default_text : String = text
var error_time : float = 3

var errored : bool = false
var cur_time : float = 0


func _process(delta):
	if(errored):
		cur_time += delta
		if(cur_time >= error_time):
			text = default_text
			errored = false

func display_error(error : String):
	cur_time = 0
	errored = true
	text = default_text + \"\\nERROR: \" + error
"

[sub_resource type="GDScript" id="GDScript_xckjp"]
script/source = "extends Button

@export var levelstarter : Node
@export var textedit : TextEdit
@export var window : Window

# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	pass


func _on_button_up():
	levelstarter.start_level_from_string(textedit.text)
	window.hide()


func _on_window_close_requested():
	window.hide()
"

[sub_resource type="GDScript" id="GDScript_tm04a"]
script/source = "extends FileDialog

@export var level_starter : Node

func _ready():
	add_filter(\"*.tscn\", \"Godot Scenes or EOLevels\")

func _on_file_selected(path):
	level_starter.start_level_from_path(path)
"

[sub_resource type="GDScript" id="GDScript_mrnkb"]
script/source = "extends Node

@export var httprequest : HTTPRequest
@export var httpcat : HTTPRequest
@export var errortext : Label
@export var image_frame : TextureRect

var tempfilepath = ProjectSettings.globalize_path(\"user://level_loaded_from_the_internet_lmao.tscn\")

func _ready():
	httprequest.request_completed.connect(self._on_http_request_completed)
	httpcat.request_completed.connect(self._on_cat_request_completed)

func start_level_from_path(path : String):
	get_tree().change_scene_to_file(path)

func start_level_from_string(string : String):
	var tempfile = FileAccess.open(tempfilepath, FileAccess.WRITE)
	if(!tempfile):
		push_warning(\"You good bro? The file path \\\"\" + tempfilepath + \"\\\" didnt seem to work.\")
		return
	tempfile.store_string(string)
	tempfile.close()
	start_level_from_path(tempfilepath)

func start_level_from_url(url : String):
	var error = httprequest.request(url)
	if(error != OK):
		errortext.display_error(\"Request errored with error \\\"\" + str(error) + \"\\\".\")
		display_error_cat(error)
func _on_http_request_completed(result, response_code, headers, body):
	display_error_cat(response_code)
	var string = body.get_string_from_utf8()
	if(string.begins_with(\"[gd_scene\")):
		start_level_from_string(string)
	else:
		start_level_from_string(string.get_slice(\"#eolevel\", 1))

func display_error_cat(errornum : int):
	var error = httpcat.request(\"https://http.cat/\" + str(errornum) + \".jpg\")
	if(error != OK):
		errortext.display_error(\"Request errored with error \\\"\" + str(error) + \"\\\" from HTTPcat.\")
func _on_cat_request_completed(result, response_code, headers, body):
	if(result != HTTPRequest.RESULT_SUCCESS):
		errortext.display_error(\"Image couldn't be downloaded. Try a different image.\")
		return

	var image = Image.new()
	var error = image.load_jpg_from_buffer(body)
	if(error != OK):
		errortext.display_error(\"Couldn't load the image.\")
		return

	var texture = ImageTexture.create_from_image(image)

	image_frame.texture = texture
"

[node name="Control" type="Control" node_paths=PackedStringArray("camera")]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = ExtResource("1_qmt1b")
camera = NodePath("Camera2D")

[node name="from_file" type="Button" parent="." node_paths=PackedStringArray("file_dialog")]
layout_mode = 0
offset_left = 450.0
offset_top = 146.0
offset_right = 714.0
offset_bottom = 221.0
text = "Load level from file."
script = SubResource("GDScript_dnww3")
file_dialog = NodePath("../stuff/FileDialog")

[node name="from_string" type="Button" parent="." node_paths=PackedStringArray("window")]
layout_mode = 0
offset_left = 454.0
offset_top = 353.0
offset_right = 718.0
offset_bottom = 428.0
text = "Load level from a string."
script = SubResource("GDScript_yf5o0")
window = NodePath("../stuff/Window")

[node name="from_url" type="Button" parent="." node_paths=PackedStringArray("line_edit", "level_starter")]
layout_mode = 0
offset_left = 853.0
offset_top = 251.0
offset_right = 1021.0
offset_bottom = 326.0
text = "Load level from URL."
script = SubResource("GDScript_c727j")
line_edit = NodePath("LineEdit")
level_starter = NodePath("../stuff/LevelStarter")

[node name="LineEdit" type="LineEdit" parent="from_url"]
layout_mode = 0
offset_left = -526.0
offset_right = -17.0
offset_bottom = 75.0
placeholder_text = "URL here"

[node name="Label" type="Label" parent="."]
layout_mode = 0
offset_left = 475.0
offset_top = 65.0
offset_right = 691.0
offset_bottom = 91.0
text = "Custom Levels :snowsmiley:"
script = SubResource("GDScript_t044l")

[node name="TextureRect" type="TextureRect" parent="."]
layout_mode = 0
offset_left = 132.0
offset_top = 335.0
offset_right = 432.0
offset_bottom = 635.0
expand_mode = 1

[node name="stuff" type="Node" parent="."]

[node name="Window" type="Window" parent="stuff"]
title = "Load a level from a string."
initial_position = 2
size = Vector2i(500, 500)
visible = false

[node name="TextEdit" type="TextEdit" parent="stuff/Window"]
offset_right = 500.0
offset_bottom = 500.0
placeholder_text = "Paset the contents of a .tscn file here."

[node name="OK" type="Button" parent="stuff/Window" node_paths=PackedStringArray("levelstarter", "textedit", "window")]
offset_left = 137.0
offset_top = 331.0
offset_right = 401.0
offset_bottom = 406.0
text = "Load level."
script = SubResource("GDScript_xckjp")
levelstarter = NodePath("../../LevelStarter")
textedit = NodePath("../TextEdit")
window = NodePath("..")

[node name="FileDialog" type="FileDialog" parent="stuff" node_paths=PackedStringArray("level_starter")]
title = "Open a File"
initial_position = 2
size = Vector2i(392, 162)
ok_button_text = "Open"
file_mode = 0
access = 2
script = SubResource("GDScript_tm04a")
level_starter = NodePath("../LevelStarter")

[node name="HTTPRequest" type="HTTPRequest" parent="stuff"]

[node name="HTTPcats" type="HTTPRequest" parent="stuff"]

[node name="LevelStarter" type="Node" parent="stuff" node_paths=PackedStringArray("httprequest", "httpcat", "errortext", "image_frame")]
script = SubResource("GDScript_mrnkb")
httprequest = NodePath("../HTTPRequest")
httpcat = NodePath("../HTTPcats")
errortext = NodePath("../../Label")
image_frame = NodePath("../../TextureRect")

[node name="Camera2D" type="Camera2D" parent="."]
anchor_mode = 0

[connection signal="button_up" from="from_file" to="from_file" method="_on_button_up"]
[connection signal="button_up" from="from_string" to="from_string" method="_on_button_up"]
[connection signal="button_up" from="from_url" to="from_url" method="_on_button_up"]
[connection signal="close_requested" from="stuff/Window" to="stuff/Window/OK" method="_on_window_close_requested"]
[connection signal="button_up" from="stuff/Window/OK" to="stuff/Window/OK" method="_on_button_up"]
[connection signal="file_selected" from="stuff/FileDialog" to="stuff/FileDialog" method="_on_file_selected"]
